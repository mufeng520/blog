---
---

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>四天周期倒计时</title>
</head>

<div class="container">
  <header>
    <h1>四天周期倒计时</h1>
    <div class="subtitle">每个周期：可争夺阶段 (第一天) + 保护阶段 (后三天)</div>
    <div class="cycle-info">总周期：4天 = 24小时(可争夺阶段) + 72小时(保护阶段)</div>
  </header>

  <div class="controls">
    <div class="filter-controls">
      <button class="filter-btn active" data-filter="all">显示全部</button>
      <button class="filter-btn" data-filter="phase1">可争夺阶段</button>
      <button class="filter-btn" data-filter="phase2">保护阶段</button>
    </div>
    <div class="stats-bar">
      <div class="stats-item">
        <span class="label">总数</span>
        <span class="value" id="totalCount">0</span>
      </div>
      <div class="stats-item">
        <span class="label">可争夺</span>
        <span class="value" id="phase1Count">0</span>
      </div>
      <div class="stats-item">
        <span class="label">保护</span>
        <span class="value" id="phase2Count">0</span>
      </div>
    </div>
  </div>

  <div class="form-container">
    <div class="input-group">
      <div class="input-item">
        <label for="projectName">工程站名称</label>
        <input type="text" id="projectName" placeholder="例如：阿尔法站、贝塔站" />
      </div>
      <div class="input-item">
        <label for="allianceName">所属联盟</label>
        <input type="text" id="allianceName" placeholder="例如：星辰联盟、光辉联盟" />
      </div>
      <div class="input-item">
        <label>剩余时间 (天:时:分)</label>
        <div class="time-input-group">
          <div class="time-input-item">
            <input type="number" id="days" placeholder="天" min="0" max="4" value="0" />
          </div>
          <div class="time-separator">:</div>
          <div class="time-input-item">
            <input type="number" id="hours" placeholder="时" min="0" max="23" value="0" />
          </div>
          <div class="time-separator">:</div>
          <div class="time-input-item">
            <input type="number" id="minutes" placeholder="分" min="0" max="59" value="0" />
          </div>
        </div>
      </div>
    </div>

    <div class="preset-times">
      <button class="preset-time" data-days="0" data-hours="1" data-minutes="0">
        还剩1小时
      </button>
      <button class="preset-time" data-days="0" data-hours="6" data-minutes="0">
        还剩6小时
      </button>
      <button class="preset-time" data-days="0" data-hours="12" data-minutes="0">
        还剩12小时
      </button>
      <button class="preset-time" data-days="1" data-hours="0" data-minutes="0">
        还剩1天
      </button>
      <button class="preset-time" data-days="3" data-hours="0" data-minutes="0">
        还剩3天
      </button>
    </div>

    <div style="margin-top: 15px;">
      <button id="addTimer">添加倒计时</button>
      <button class="secondary" id="resetAll">重置所有</button>
    </div>
  </div>

  <div class="timers-container" id="timersContainer">
    <!-- 倒计时卡片将通过JavaScript动态添加 -->
    <div class="empty-state" id="emptyState">
      <h3>暂无倒计时</h3>
      <p>点击"添加倒计时"按钮创建第一个倒计时</p>
    </div>
  </div>
</div>

<style is:global>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Microsoft YaHei', sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #fff;
    min-height: 100vh;
    padding: 10px;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  header {
    text-align: center;
    margin-bottom: 15px;
    padding: 8px;
  }

  h1 {
    font-size: 1.6rem;
    margin-bottom: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  .subtitle {
    font-size: 0.85rem;
    color: #94a3b8;
    margin-bottom: 4px;
  }

  .cycle-info {
    font-size: 0.75rem;
    color: #fbbf24;
    background: rgba(251, 191, 36, 0.1);
    padding: 3px 8px;
    border-radius: 10px;
    display: inline-block;
    margin-top: 4px;
  }

  .controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-controls {
    display: flex;
    gap: 8px;
  }

  .filter-btn {
    background: rgba(30, 41, 59, 0.7);
    color: #94a3b8;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
  }

  .filter-btn.active {
    background: linear-gradient(90deg, #3b82f6, #6366f1);
    color: white;
    border-color: transparent;
  }

  .filter-btn:hover {
    background: rgba(59, 130, 246, 0.2);
  }

  .form-container {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .input-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }

  .input-item {
    flex: 1;
    min-width: 160px;
  }

  .time-input-group {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .time-input-item {
    flex: 1;
  }

  .time-input-item input {
    text-align: center;
  }

  .time-separator {
    color: #94a3b8;
    font-size: 0.9rem;
  }

  label {
    display: block;
    margin-bottom: 3px;
    color: #60a5fa;
    font-weight: 500;
    font-size: 0.8rem;
  }

  input {
    width: 100%;
    padding: 7px 9px;
    background: rgba(15, 23, 42, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: white;
    font-size: 0.85rem;
    transition: all 0.3s ease;
  }

  input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }

  button {
    background: linear-gradient(90deg, #3b82f6, #6366f1);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-right: 6px;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
  }

  button.secondary {
    background: linear-gradient(90deg, #ef4444, #dc2626);
  }

  .timers-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 12px;
  }

  .timer-card {
    background: linear-gradient(
      145deg,
      rgba(30, 41, 59, 0.9),
      rgba(15, 23, 42, 0.9)
    );
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.3s ease, opacity 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .timer-card.phase-1 {
    border-left: 4px solid #ef4444;
  }

  .timer-card.phase-2 {
    border-left: 4px solid #10b981;
  }

  .timer-card.hidden {
    display: none;
  }

  .timer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .timer-title-container {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
  }

  .project-name {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
  }

  .alliance-name {
    font-size: 0.75rem;
    color: #94a3b8;
  }

  .header-actions {
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }

  .phase-indicator {
    background: rgba(239, 68, 68, 0.2);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    color: #ef4444;
    white-space: nowrap;
    margin-top: 2px;
  }

  .phase-2 {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
  }

  .delete-btn {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .delete-btn:hover {
    background: rgba(239, 68, 68, 0.4);
    transform: scale(1.1);
  }

  .timer-display {
    text-align: center;
    margin: 15px 0;
  }

  .time-left {
    font-size: 1.3rem;
    font-weight: 700;
    background: linear-gradient(90deg, #60a5fa, #a78bfa);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin-bottom: 3px;
    font-family: 'Courier New', monospace;
  }

  .time-label {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 2px;
  }

  .integrated-progress {
    margin: 15px 0 10px;
  }

  .phase-progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    font-size: 0.7rem;
  }

  .phase-label {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .phase-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #ef4444;
  }

  .phase-2 .phase-dot {
    background: #10b981;
  }

  .phase-text {
    color: #cbd5e1;
    font-weight: 500;
  }

  .phase-time {
    color: #fbbf24;
    font-weight: 600;
  }

  .progress-container {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #60a5fa, #a78bfa);
    border-radius: 3px;
    transition: width 1s ease;
    position: relative;
  }

  .progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 2px;
    background: rgba(255, 255, 255, 0.5);
  }

  .progress-percent {
    position: absolute;
    right: 4px;
    top: -14px;
    font-size: 0.65rem;
    color: #94a3b8;
  }

  .empty-state {
    text-align: center;
    padding: 25px 10px;
    color: #94a3b8;
    grid-column: 1 / -1;
  }

  .empty-state h3 {
    margin-bottom: 6px;
    color: #60a5fa;
    font-size: 1rem;
  }

  .empty-state p {
    font-size: 0.8rem;
  }

  @media (max-width: 768px) {
    .timers-container {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    }

    h1 {
      font-size: 1.4rem;
    }

    .controls {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-controls {
      justify-content: center;
    }

    .time-input-group {
      flex-wrap: wrap;
    }
  }

  @media (max-width: 480px) {
    .timers-container {
      grid-template-columns: 1fr;
    }
  }

  .stats-bar {
    display: flex;
    justify-content: space-between;
    margin: 6px 0;
    padding: 5px;
    background: rgba(15, 23, 42, 0.4);
    border-radius: 4px;
    font-size: 0.75rem;
  }

  .stats-item {
    text-align: center;
    flex: 1;
  }

  .stats-item .label {
    display: block;
    color: #94a3b8;
    font-size: 0.65rem;
    margin-bottom: 1px;
  }

  .stats-item .value {
    display: block;
    color: #60a5fa;
    font-weight: 600;
    font-size: 0.8rem;
  }

  .preset-times {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .preset-time {
    background: rgba(59, 130, 246, 0.2);
    border: none;
    color: #60a5fa;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .preset-time:hover {
    background: rgba(59, 130, 246, 0.4);
    transform: translateY(-1px);
  }
</style>

<script is:inline>
  // 存储所有倒计时的数组
  let timers = [];
  let timerElements = {}; // 存储DOM元素的引用
  let currentFilter = 'all'; // 当前筛选状态

  // 从本地存储加载倒计时
  function loadTimers() {
    const saved = localStorage.getItem('phaseTimers');
    if (saved) {
      timers = JSON.parse(saved);
      updateDisplay();
    }
  }

  // 保存倒计时到本地存储
  function saveTimers() {
    localStorage.setItem('phaseTimers', JSON.stringify(timers));
  }

  // 计算周期倒计时 (1天 + 3天模式)
  function calculateRemainingTime(startDate) {
    const start = new Date(startDate);
    const now = new Date();

    // 计算从开始时间到现在经过的总毫秒数
    const elapsedMs = now.getTime() - start.getTime();
    const elapsedSec = elapsedMs / 1000;

    // 阶段1时长 (1天 = 24小时) - 可争夺阶段
    const phase1Seconds = 24 * 60 * 60; // 86400秒
    // 阶段2时长 (3天 = 72小时) - 保护阶段
    const phase2Seconds = 72 * 60 * 60; // 259200秒
    // 总周期时长 (4天)
    const totalCycleSeconds = phase1Seconds + phase2Seconds; // 345600秒

    // 确定当前所处的周期和阶段
    let currentCycle = Math.floor(elapsedSec / totalCycleSeconds);
    let elapsedInCurrentCycle = elapsedSec % totalCycleSeconds;

    let currentPhase = 1;
    let phaseRemaining = 0;
    let totalRemaining = 0;
    let phaseProgress = 0;

    // 始终从阶段1开始
    if (elapsedInCurrentCycle < phase1Seconds) {
      currentPhase = 1;
      phaseRemaining = phase1Seconds - elapsedInCurrentCycle;
      phaseProgress = (elapsedInCurrentCycle / phase1Seconds) * 100;
    } else {
      currentPhase = 2;
      const elapsedInPhase2 = elapsedInCurrentCycle - phase1Seconds;
      phaseRemaining = phase2Seconds - elapsedInPhase2;
      phaseProgress = (elapsedInPhase2 / phase2Seconds) * 100;
    }

    // 计算当前周期剩余总时间
    totalRemaining = totalCycleSeconds - elapsedInCurrentCycle;

    // 转换为天、小时、分钟、秒
    const days = Math.floor(totalRemaining / (24 * 60 * 60));
    const hours = Math.floor(
      (totalRemaining % (24 * 60 * 60)) / (60 * 60)
    );
    const minutes = Math.floor((totalRemaining % (60 * 60)) / 60);
    const seconds = Math.floor(totalRemaining % 60);

    // 计算阶段剩余时间
    const phaseHours = Math.floor(phaseRemaining / (60 * 60));
    const phaseMinutes = Math.floor(
      (phaseRemaining % (60 * 60)) / 60
    );
    const phaseSeconds = Math.floor(phaseRemaining % 60);

    return {
      days,
      hours,
      minutes,
      seconds,
      currentPhase,
      phaseRemaining,
      phaseHours,
      phaseMinutes,
      phaseSeconds,
      phaseProgress,
      totalRemaining,
      totalCycleSeconds,
      currentCycle,
      elapsedInCurrentCycle,
      formatted: `${days}天 ${hours
        .toString()
        .padStart(2, '0')}:${minutes
        .toString()
        .padStart(2, '0')}:${seconds
        .toString()
        .padStart(2, '0')}`,
      phaseFormatted: `${phaseHours
        .toString()
        .padStart(2, '0')}:${phaseMinutes
        .toString()
        .padStart(2, '0')}:${phaseSeconds
        .toString()
        .padStart(2, '0')}`,
    };
  }

  // 更新统计信息
  function updateStats() {
    const phase1Count = timers.filter((timer) => {
      const remaining = calculateRemainingTime(timer.startTime);
      return remaining.currentPhase === 1;
    }).length;

    const phase2Count = timers.filter((timer) => {
      const remaining = calculateRemainingTime(timer.startTime);
      return remaining.currentPhase === 2;
    }).length;

    document.getElementById('totalCount').textContent =
      timers.length;
    document.getElementById('phase1Count').textContent =
      phase1Count;
    document.getElementById('phase2Count').textContent =
      phase2Count;
  }

  // 排序函数：按照可争夺状态在前，倒计时短的在前的顺序排序
  function getSortedTimers() {
    // 创建副本进行排序，不改变原数组
    const timersCopy = [...timers];

    // 排序逻辑：
    // 1. 首先按阶段排序：可争夺阶段(1)在前，保护阶段(2)在后
    // 2. 同阶段内按剩余时间（totalRemaining）升序排序
    timersCopy.sort((a, b) => {
      const remainingA = calculateRemainingTime(a.startTime);
      const remainingB = calculateRemainingTime(b.startTime);

      // 首先按阶段排序：阶段1（可争夺阶段）在前
      if (remainingA.currentPhase !== remainingB.currentPhase) {
        return remainingA.currentPhase - remainingB.currentPhase;
      }

      // 同阶段内，按剩余时间升序排序（剩余时间短的在前）
      return remainingA.totalRemaining - remainingB.totalRemaining;
    });

    return timersCopy;
  }

  // 更新单个倒计时卡片
  function updateTimerCard(timer, element, index) {
    const remaining = calculateRemainingTime(timer.startTime);

    // 更新卡片阶段类
    element.className = 'timer-card';
    element.classList.add(`phase-${remaining.currentPhase}`);

    // 根据筛选条件显示/隐藏
    if (currentFilter === 'phase1' && remaining.currentPhase !== 1) {
      element.classList.add('hidden');
    } else if (
      currentFilter === 'phase2' &&
      remaining.currentPhase !== 2
    ) {
      element.classList.add('hidden');
    }

    // 更新计时器显示
    const timeLeft = element.querySelector('.time-left');
    timeLeft.textContent = remaining.formatted;

    // 更新阶段指示器
    const phaseIndicator = element.querySelector('.phase-indicator');
    phaseIndicator.textContent =
      remaining.currentPhase === 1 ? '可争夺阶段' : '保护阶段';
    phaseIndicator.className = `phase-indicator ${
      remaining.currentPhase === 1 ? '' : 'phase-2'
    }`;

    // 更新整合的进度条信息
    const phaseText = element.querySelector('.phase-text');
    const phaseTime = element.querySelector('.phase-time');
    const progressFill = element.querySelector('.progress-fill');
    const progressPercent =
      element.querySelector('.progress-percent');

    if (phaseText) {
      phaseText.textContent =
        remaining.currentPhase === 1
          ? '可争夺阶段 (第一天)'
          : '保护阶段 (后三天)';
    }

    if (phaseTime) {
      phaseTime.textContent = remaining.phaseFormatted;
    }

    if (progressFill) {
      progressFill.style.width = `${remaining.phaseProgress}%`;
    }

    if (progressPercent) {
      progressPercent.textContent =
        `${remaining.phaseProgress.toFixed(1)}%`;
    }
  }

  // 创建倒计时卡片 (只在添加时创建一次)
  function createTimerCard(timer, index) {
    const remaining = calculateRemainingTime(timer.startTime);

    const card = document.createElement('div');
    card.className = `timer-card phase-${remaining.currentPhase}`;
    card.id = `timer-${index}`;
    card.innerHTML = `
                <div class="timer-header">
                    <div class="timer-title-container">
                        <div class="project-name">${timer.project}</div>
                        <div class="alliance-name">${timer.alliance}</div>
                    </div>
                    <div class="header-actions">
                        <div class="phase-indicator ${
                          remaining.currentPhase === 1 ? '' : 'phase-2'
                        }">${
      remaining.currentPhase === 1 ? '可争夺阶段' : '保护阶段'
    }</div>
                        <button class="delete-btn" data-index="${index}">×</button>
                    </div>
                </div>
                
                <div class="timer-display">
                    <div class="time-left">${remaining.formatted}</div>
                    <div class="time-label">当前周期剩余时间</div>
                </div>
                
                <div class="integrated-progress">
                    <div class="phase-progress-info">
                        <div class="phase-label">
                            <div class="phase-dot"></div>
                            <div class="phase-text">${
                              remaining.currentPhase === 1
                                ? '可争夺阶段 (第一天)'
                                : '保护阶段 (后三天)'
                            }</div>
                        </div>
                        <div class="phase-time">${
                          remaining.phaseFormatted
                        }</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" style="width: ${
                          remaining.phaseProgress
                        }%"></div>
                        <div class="progress-percent">${remaining.phaseProgress.toFixed(
                          1
                        )}%</div>
                    </div>
                </div>
            `;

    // 添加删除功能
    const deleteBtn = card.querySelector('.delete-btn');
    deleteBtn.addEventListener('click', function () {
      deleteTimer(index);
    });

    return card;
  }

  // 更新显示 (按照排序顺序创建卡片)
  function updateDisplay() {
    const container = document.getElementById('timersContainer');
    const emptyState = document.getElementById('emptyState');

    // 清空容器，但保留emptyState
    container.innerHTML = '';
    container.appendChild(emptyState);

    if (timers.length === 0) {
      emptyState.style.display = 'block';
      timerElements = {}; // 清空元素缓存
      updateStats();
      return;
    }

    emptyState.style.display = 'none';

    // 按照排序顺序创建卡片
    const sortedTimers = getSortedTimers();
    sortedTimers.forEach((timer) => {
      // 找到原数组中的索引
      const originalIndex = timers.findIndex(
        (t) =>
          t.project === timer.project &&
          t.alliance === timer.alliance &&
          t.startTime === timer.startTime
      );

      if (originalIndex !== -1) {
        const card = createTimerCard(timer, originalIndex);
        container.appendChild(card);
        timerElements[originalIndex] = card; // 缓存DOM元素
      }
    });

    updateStats();
  }

  // 只更新时间，不重新创建DOM，但重新排序DOM元素
  function updateTimers() {
    if (timers.length === 0) return;

    // 获取排序后的顺序
    const sortedTimers = getSortedTimers();

    // 更新所有卡片内容
    timers.forEach((timer, index) => {
      const element = timerElements[index];
      if (element) {
        updateTimerCard(timer, element, index);
      }
    });

    // 重新排序DOM元素：将元素按照排序顺序重新插入
    // 创建一个文档片段，按照排序顺序添加元素
    const container = document.getElementById('timersContainer');
    const fragment = document.createDocumentFragment();
    const emptyState = document.getElementById('emptyState');

    // 先移除空状态
    emptyState.style.display = 'none';

    sortedTimers.forEach((timer) => {
      // 找到原数组中的索引
      const originalIndex = timers.findIndex(
        (t) =>
          t.project === timer.project &&
          t.alliance === timer.alliance &&
          t.startTime === timer.startTime
      );

      if (originalIndex !== -1 && timerElements[originalIndex]) {
        fragment.appendChild(timerElements[originalIndex]);
      }
    });

    // 清空容器并添加重新排序的元素
    container.innerHTML = '';
    container.appendChild(emptyState);
    container.appendChild(fragment);

    updateStats();
  }

  // 根据输入的剩余时间计算开始时间
  function calculateStartTimeFromRemainingTime(
    remainingDays,
    remainingHours,
    remainingMinutes
  ) {
    const now = new Date();

    // 将输入的剩余时间转换为秒
    const remainingSeconds =
      remainingDays * 24 * 60 * 60 +
      remainingHours * 60 * 60 +
      remainingMinutes * 60;

    // 总周期时长 (4天 = 345600秒)
    const totalCycleSeconds = 24 * 60 * 60 + 72 * 60 * 60; // 345600秒

    // 计算已经过去的时间 = 总周期 - 剩余时间
    const elapsedSeconds = totalCycleSeconds - remainingSeconds;

    // 开始时间 = 现在 - 已经过去的时间
    const startTime = new Date(
      now.getTime() - elapsedSeconds * 1000
    );
    return startTime;
  }

  // 添加新倒计时
  function addTimer() {
    const projectInput = document.getElementById('projectName');
    const allianceInput = document.getElementById('allianceName');
    const daysInput = document.getElementById('days');
    const hoursInput = document.getElementById('hours');
    const minutesInput = document.getElementById('minutes');

    const project = projectInput.value.trim();
    const alliance = allianceInput.value.trim();
    const days = parseInt(daysInput.value) || 0;
    const hours = parseInt(hoursInput.value) || 0;
    const minutes = parseInt(minutesInput.value) || 0;

    if (!project) {
      alert('请输入工程站名称');
      projectInput.focus();
      return;
    }

    if (!alliance) {
      alert('请输入所属联盟');
      allianceInput.focus();
      return;
    }

    // 检查输入的剩余时间是否合理
    const totalRemainingSeconds =
      days * 24 * 60 * 60 + hours * 60 * 60 + minutes * 60;
    const totalCycleSeconds = 24 * 60 * 60 + 72 * 60 * 60; // 345600秒

    if (totalRemainingSeconds > totalCycleSeconds) {
      alert('剩余时间不能超过4天（96小时）');
      return;
    }

    // 检查是否已存在相同工程站名称的倒计时
    const exists = timers.some((timer) => timer.project === project);
    if (exists) {
      alert('已存在相同工程站名称的倒计时，请使用不同的名称');
      return;
    }

    // 计算开始时间（基于剩余时间）
    const startTime = calculateStartTimeFromRemainingTime(
      days,
      hours,
      minutes
    );

    // 添加到数组 (固定从阶段1开始)
    timers.push({
      project: project,
      alliance: alliance,
      startTime: startTime.toISOString(),
      createdAt: new Date().toISOString(),
    });

    // 清空表单
    projectInput.value = '';
    allianceInput.value = '';
    daysInput.value = '0';
    hoursInput.value = '0';
    minutesInput.value = '0';

    // 保存并更新显示
    saveTimers();
    updateDisplay();
  }

  // 删除倒计时
  function deleteTimer(index) {
    if (confirm('确定要删除这个倒计时吗？')) {
      timers.splice(index, 1);

      // 从DOM中移除对应卡片
      const element = timerElements[index];
      if (element) {
        element.remove();
        delete timerElements[index];
      }

      // 重新索引缓存
      const newTimerElements = {};
      timers.forEach((timer, newIndex) => {
        if (timerElements[newIndex] !== undefined) {
          newTimerElements[newIndex] = timerElements[newIndex];
        }
      });
      timerElements = newTimerElements;

      // 更新删除按钮的索引
      Object.keys(timerElements).forEach((key) => {
        const btn = timerElements[key].querySelector('.delete-btn');
        if (btn) {
          btn.setAttribute('data-index', key);
        }
      });

      updateDisplay();
      saveTimers();
    }
  }

  // 重置所有倒计时
  function resetAllTimers() {
    if (timers.length === 0) {
      alert('当前没有倒计时');
      return;
    }

    if (confirm('确定要删除所有倒计时吗？此操作不可撤销。')) {
      timers = [];
      timerElements = {};
      saveTimers();
      updateDisplay();
    }
  }

  // 应用筛选
  function applyFilter(filter) {
    currentFilter = filter;

    // 更新筛选按钮状态
    document.querySelectorAll('.filter-btn').forEach((btn) => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-filter') === filter) {
        btn.classList.add('active');
      }
    });

    // 更新所有卡片显示状态
    timers.forEach((timer, index) => {
      const element = timerElements[index];
      if (element) {
        const remaining = calculateRemainingTime(timer.startTime);

        element.classList.remove('hidden');

        if (filter === 'phase1' && remaining.currentPhase !== 1) {
          element.classList.add('hidden');
        } else if (
          filter === 'phase2' &&
          remaining.currentPhase !== 2
        ) {
          element.classList.add('hidden');
        }
      }
    });
  }

  // 初始化
  function init() {
    // 加载已有倒计时
    loadTimers();

    // 绑定事件
    document
      .getElementById('addTimer')
      .addEventListener('click', addTimer);
    document
      .getElementById('resetAll')
      .addEventListener('click', resetAllTimers);

    // 绑定筛选按钮事件
    document.querySelectorAll('.filter-btn').forEach((btn) => {
      btn.addEventListener('click', function () {
        const filter = this.getAttribute('data-filter');
        applyFilter(filter);
      });
    });

    // 绑定预设时间按钮事件
    document.querySelectorAll('.preset-time').forEach((btn) => {
      btn.addEventListener('click', function () {
        const days = this.getAttribute('data-days');
        const hours = this.getAttribute('data-hours');
        const minutes = this.getAttribute('data-minutes');

        document.getElementById('days').value = days;
        document.getElementById('hours').value = hours;
        document.getElementById('minutes').value = minutes;
      });
    });

    // 每秒更新一次倒计时
    setInterval(updateTimers, 1000);

    // 允许按Enter键添加倒计时
    document
      .getElementById('projectName')
      .addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          addTimer();
        }
      });

    document
      .getElementById('allianceName')
      .addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          addTimer();
        }
      });
  }

  // 页面加载完成后初始化（兼容 Astro 可能在 DOMContentLoaded 之后再执行脚本的情况）
  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
