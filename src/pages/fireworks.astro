---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="çƒŸèŠ±ç§€ - æœ¨é£">
  <style>
    .fireworks-container {
      width: 100%;
      height: calc(100vh - 250px);
      min-height: 600px;
      position: relative;
      background: linear-gradient(to bottom, #0a0a1e 0%, #1a1a3e 50%, #0a0a1e 100%);
      overflow: hidden;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    #fireworks-canvas-container {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    .fireworks-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 10;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-btn {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
    }

    .control-btn.active {
      background: rgba(236, 72, 153, 0.3);
      border-color: #ec4899;
    }

    .page-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 10px;
      font-weight: 300;
      letter-spacing: 2px;
      text-shadow: 0 2px 10px rgba(236, 72, 153, 0.5);
    }

    .page-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
    }

    #fireworks-canvas-container canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    @media (max-width: 768px) {
      .fireworks-container {
        height: calc(100vh - 150px);
        min-height: 500px;
      }

      .controls {
        bottom: 15px;
        gap: 10px;
      }

      .control-btn {
        padding: 10px 18px;
        font-size: 0.85rem;
      }

      .page-title {
        font-size: 2rem;
      }
    }
  </style>

  <div class="fireworks-wrapper">
    <div class="page-header">
      <h1 class="page-title">ğŸ† çƒŸèŠ±ç§€</h1>
      <p class="page-subtitle">ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±ï¼Œæˆ–å¼€å¯è‡ªåŠ¨æ¨¡å¼</p>
    </div>

    <div class="fireworks-container">
      <div id="fireworks-canvas-container"></div>
      <div class="controls">
        <button class="control-btn" id="auto-mode-btn">è‡ªåŠ¨æ¨¡å¼</button>
        <button class="control-btn" id="pause-btn">æš‚åœ</button>
        <button class="control-btn" id="clear-btn">æ¸…é™¤</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js" is:inline></script>
  <script is:inline>
    function initFireworks() {
      if (typeof p5 === 'undefined') {
        setTimeout(initFireworks, 100);
        return;
      }

      const containerId = 'fireworks-canvas-container';
      let fireworks = [];
      let particles = [];
      let autoMode = false;
      let isPaused = false;
      let nextLaunchTime = 0;
      let launchFireworkFunc = null;

      // çƒŸèŠ±é¢œè‰²ä¸»é¢˜
      const colors = [
        { r: 255, g: 0, b: 67 },      // çº¢è‰²
        { r: 20, g: 252, b: 86 },     // ç»¿è‰²
        { r: 30, g: 127, b: 255 },    // è“è‰²
        { r: 230, g: 10, b: 255 },    // ç´«è‰²
        { r: 255, g: 191, b: 54 },    // é‡‘è‰²
        { r: 255, g: 255, b: 255 },   // ç™½è‰²
        { r: 236, g: 72, b: 153 },    // ç²‰è‰²
        { r: 96, g: 165, b: 250 }     // æµ…è“è‰²
      ];

      new p5(function(p) {
        p.setup = function() {
          const container = document.getElementById(containerId);
          if (!container) {
            console.error('Container not found');
            return;
          }
          
          // è·å–å®¹å™¨å°ºå¯¸
          let width = container.offsetWidth;
          let height = container.offsetHeight;
          
          // å¦‚æœå°ºå¯¸ä¸º0æˆ–å¤ªå°ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
          if (width < 100) {
            width = container.clientWidth || window.innerWidth - 40;
          }
          if (height < 100) {
            height = container.clientHeight || window.innerHeight - 300;
          }
          
          // ç¡®ä¿æœ€å°å°ºå¯¸
          width = Math.max(width, 800);
          height = Math.max(height, 600);
          
          const canvas = p.createCanvas(width, height);
          canvas.parent(containerId);
          
          console.log('Canvas created:', width, 'x', height, 'Container size:', container.offsetWidth, 'x', container.offsetHeight);
        };

        p.windowResized = function() {
          const container = document.getElementById(containerId);
          if (!container) return;
          let width = container.offsetWidth || container.clientWidth || 800;
          let height = container.offsetHeight || container.clientHeight || 600;
          width = Math.max(width, 800);
          height = Math.max(height, 600);
          p.resizeCanvas(width, height);
        };

        p.draw = function() {
          if (isPaused) return;

          // ä½¿ç”¨ä½é€æ˜åº¦èƒŒæ™¯åˆ›å»ºæ‹–å°¾æ•ˆæœ
          p.background(10, 10, 30, 15);

          // è‡ªåŠ¨å‘å°„çƒŸèŠ±
          if (autoMode && p.millis() > nextLaunchTime) {
            const x = p.random(0.2 * p.width, 0.8 * p.width);
            const y = p.random(0.2 * p.height, 0.5 * p.height);
            if (launchFireworkFunc) {
              launchFireworkFunc(x, y);
            }
            nextLaunchTime = p.millis() + p.random(800, 2000);
          }

          // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
          for (let i = fireworks.length - 1; i >= 0; i--) {
            const fw = fireworks[i];
            fw.update();
            fw.show();

            if (fw.exploded && fw.particles.length === 0) {
              fireworks.splice(i, 1);
            }
          }

          // æ›´æ–°å’Œç»˜åˆ¶ç‹¬ç«‹ç²’å­
          for (let i = particles.length - 1; i >= 0; i--) {
            const pt = particles[i];
            pt.update();
            pt.show();

            if (pt.life <= 0) {
              particles.splice(i, 1);
            }
          }
        };

        p.mousePressed = function() {
          if (p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
            if (launchFireworkFunc) {
              launchFireworkFunc(p.mouseX, p.mouseY);
            }
          }
        };

        launchFireworkFunc = function(x, y) {
          const color = colors[Math.floor(Math.random() * colors.length)];
          fireworks.push(new Firework(x, y, color));
        };

        // çƒŸèŠ±ç±»
        function Firework(targetX, targetY, color) {
          this.startX = p.random(0.2 * p.width, 0.8 * p.width);
          this.startY = p.height;
          this.targetX = targetX;
          this.targetY = targetY;
          this.x = this.startX;
          this.y = this.startY;
          this.exploded = false;
          this.particles = [];
          this.color = color;
          this.trail = []; // è½¨è¿¹ç‚¹æ•°ç»„
          this.vx = (this.targetX - this.startX) / 60;
          this.vy = (this.targetY - this.startY) / 60;
          this.speed = p.dist(this.startX, this.startY, this.targetX, this.targetY) / 60;

          this.update = function() {
            if (!this.exploded) {
              // ä¿å­˜è½¨è¿¹ç‚¹
              this.trail.push({x: this.x, y: this.y, life: 255});
              
              this.x += this.vx;
              this.y += this.vy;

              // æ›´æ–°è½¨è¿¹ç‚¹ç”Ÿå‘½å€¼
              for (let i = this.trail.length - 1; i >= 0; i--) {
                this.trail[i].life -= 8;
                if (this.trail[i].life <= 0) {
                  this.trail.splice(i, 1);
                }
              }

              // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç›®æ ‡
              if (p.dist(this.x, this.y, this.targetX, this.targetY) < 5) {
                this.explode();
              }
            } else {
              // æ›´æ–°çˆ†ç‚¸ç²’å­
              for (let i = this.particles.length - 1; i >= 0; i--) {
                const pt = this.particles[i];
                pt.update();
                if (pt.life <= 0) {
                  this.particles.splice(i, 1);
                }
              }
            }
          };

          this.show = function() {
            if (!this.exploded) {
              // ç»˜åˆ¶è½¨è¿¹ï¼ˆä½¿ç”¨æ­£ç¡®çš„é¢œè‰²ï¼‰
              for (let i = 0; i < this.trail.length - 1; i++) {
                const alpha = this.trail[i].life;
                p.stroke(this.color.r, this.color.g, this.color.b, alpha);
                p.strokeWeight(3 * (alpha / 255));
                p.line(this.trail[i].x, this.trail[i].y, 
                       this.trail[i + 1].x, this.trail[i + 1].y);
              }
              
              // ç»˜åˆ¶ä¸Šå‡çš„çƒŸèŠ±ï¼ˆå¸¦å…‰æ™•æ•ˆæœï¼‰
              p.fill(this.color.r, this.color.g, this.color.b, 255);
              p.noStroke();
              p.ellipse(this.x, this.y, 6, 6);
              
              // å…‰æ™•æ•ˆæœ
              p.fill(this.color.r, this.color.g, this.color.b, 100);
              p.ellipse(this.x, this.y, 12, 12);
            } else {
              // ç»˜åˆ¶çˆ†ç‚¸ç²’å­
              for (const pt of this.particles) {
                pt.show();
              }
            }
          };

          this.explode = function() {
            this.exploded = true;
            const particleCount = 80 + Math.floor(Math.random() * 70);
            
            // ä¸»è¦çˆ†ç‚¸ - åœ†å½¢åˆ†å¸ƒ
            for (let i = 0; i < particleCount; i++) {
              const angle = (p.TWO_PI / particleCount) * i;
              const speed = 2 + Math.random() * 5;
              this.particles.push(new Particle(
                this.x, this.y,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                this.color,
                255,
                true
              ));
            }

            // æ·»åŠ ä¸€äº›éšæœºé¢œè‰²ç²’å­ï¼ˆå¢åŠ è§†è§‰ä¸°å¯Œåº¦ï¼‰
            for (let i = 0; i < 30; i++) {
              const randomColor = colors[Math.floor(Math.random() * colors.length)];
              const angle = Math.random() * p.TWO_PI;
              const speed = 1.5 + Math.random() * 4;
              this.particles.push(new Particle(
                this.x, this.y,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                randomColor,
                220,
                false
              ));
            }

            // æ·»åŠ å¿«é€Ÿé£è¡Œçš„ç«èŠ±
            for (let i = 0; i < 15; i++) {
              const angle = Math.random() * p.TWO_PI;
              const speed = 6 + Math.random() * 4;
              this.particles.push(new Particle(
                this.x, this.y,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                this.color,
                180,
                true,
                true // æ˜¯ç«èŠ±
              ));
            }
          };
        }

        // ç²’å­ç±»
        function Particle(x, y, vx, vy, color, life, isMain, isSpark) {
          this.x = x;
          this.y = y;
          this.vx = vx;
          this.vy = vy;
          this.life = life;
          this.maxLife = life;
          this.color = color;
          this.gravity = isSpark ? 0.02 : 0.05; // ç«èŠ±é‡åŠ›æ›´å°
          this.fade = isSpark ? life / 120 : life / 200; // ç«èŠ±æ¶ˆå¤±æ›´å¿«
          this.isMain = isMain || false;
          this.isSpark = isSpark || false;
          this.trail = []; // ç²’å­è½¨è¿¹

          this.update = function() {
            // ä¿å­˜è½¨è¿¹ç‚¹
            if (this.isMain && this.life > 50) {
              this.trail.push({x: this.x, y: this.y, life: 100});
            }
            
            // æ›´æ–°è½¨è¿¹
            for (let i = this.trail.length - 1; i >= 0; i--) {
              this.trail[i].life -= 5;
              if (this.trail[i].life <= 0) {
                this.trail.splice(i, 1);
              }
            }
            
            this.vx *= 0.99; // ç©ºæ°”é˜»åŠ›
            this.vy *= 0.99;
            this.vy += this.gravity; // é‡åŠ›
            this.x += this.vx;
            this.y += this.vy;
            this.life -= this.fade;
          };

          this.show = function() {
            const alpha = (this.life / this.maxLife) * 255;
            const size = this.isSpark ? 2 : (this.isMain ? 4 : 3) * (this.life / this.maxLife);
            
            // ç»˜åˆ¶è½¨è¿¹
            if (this.trail.length > 1) {
              for (let i = 0; i < this.trail.length - 1; i++) {
                const trailAlpha = (this.trail[i].life / 100) * alpha * 0.5;
                p.stroke(this.color.r, this.color.g, this.color.b, trailAlpha);
                p.strokeWeight(2);
                p.line(this.trail[i].x, this.trail[i].y, 
                       this.trail[i + 1].x, this.trail[i + 1].y);
              }
            }
            
            // ç»˜åˆ¶ç²’å­ä¸»ä½“
            p.fill(this.color.r, this.color.g, this.color.b, alpha);
            p.noStroke();
            p.ellipse(this.x, this.y, size, size);
            
            // æ·»åŠ å…‰æ™•æ•ˆæœï¼ˆä¸»è¦ç²’å­ï¼‰
            if (this.isMain && this.life > 30) {
              p.fill(this.color.r, this.color.g, this.color.b, alpha * 0.4);
              p.ellipse(this.x, this.y, size * 2.5, size * 2.5);
            }
            
            // ç«èŠ±æ•ˆæœï¼ˆæ›´äº®ï¼‰
            if (this.isSpark) {
              p.fill(this.color.r, this.color.g, this.color.b, alpha * 1.2);
              p.ellipse(this.x, this.y, size * 0.8, size * 0.8);
            }
          };
        }
      });

      // æ§åˆ¶æŒ‰é’®äº‹ä»¶
      const autoModeBtn = document.getElementById('auto-mode-btn');
      const pauseBtn = document.getElementById('pause-btn');
      const clearBtn = document.getElementById('clear-btn');

      if (autoModeBtn) {
        autoModeBtn.addEventListener('click', function() {
          autoMode = !autoMode;
          this.classList.toggle('active', autoMode);
          this.textContent = autoMode ? 'å…³é—­è‡ªåŠ¨' : 'è‡ªåŠ¨æ¨¡å¼';
          if (autoMode) {
            nextLaunchTime = 0;
          }
        });
      }

      if (pauseBtn) {
        pauseBtn.addEventListener('click', function() {
          isPaused = !isPaused;
          this.classList.toggle('active', isPaused);
          this.textContent = isPaused ? 'ç»§ç»­' : 'æš‚åœ';
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener('click', function() {
          fireworks = [];
          particles = [];
        });
      }

      // åˆå§‹å‘å°„å‡ ä¸ªçƒŸèŠ±
      setTimeout(function() {
        for (let i = 0; i < 3; i++) {
          setTimeout(function() {
            const container = document.getElementById(containerId);
            if (container) {
              const x = container.offsetWidth * (0.3 + 0.4 * (i / 2));
              const y = container.offsetHeight * 0.3;
              if (launchFireworkFunc) {
                launchFireworkFunc(x, y);
              }
            }
          }, i * 300);
        }
      }, 500);
    }

    // ç­‰å¾… DOM å’Œ p5.js éƒ½å‡†å¤‡å¥½
    function startInit() {
      // ç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
      const container = document.getElementById('fireworks-canvas-container');
      if (container && container.offsetHeight > 0) {
        initFireworks();
      } else {
        setTimeout(startInit, 50);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(startInit, 100);
      });
    } else {
      setTimeout(startInit, 100);
    }
  </script>
</BaseLayout>
